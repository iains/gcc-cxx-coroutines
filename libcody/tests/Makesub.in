# CODYlib		-*- mode:Makefile -*-
# Copyright (C) 2019-2020 Nathan Sidwell, nathan@acm.org
# License: Apache v2.0

ALOY := @ALOY@
TESTS := $(patsubst $(srcdir)/%.cc,%,\
	$(wildcard $(srcdir)/tests/*/*.cc))
TESTDIRS = $(shell cd $(srcdir)/${<D} ; echo *(/))
testdir := $(and $(filter-out /%,$(srcdir)),../)$(srcdir)/tests

check:: tests/cody.defs $(TESTS)
	+cd ${<D} && srcbuilddir=$(srcdir)/tests JOUST=${<F} \
	  $(ALOY) -t kratos -o cody -g $(testdir)/jouster $(TESTDIRS)
ifeq ($(firstword $(aloy)),:)
	@echo WARNING: tests were not run as Joust test harness was not found
endif

tests/cody.defs: tests/Makesub
	echo '# Automatically generated by Make' >$@
	echo 'testdir=$(testdir)' >>$@
	echo 'timelimit=60' >>$@
	echo 'memlimit=1' >>$@
	echo 'cpulimit=60' >>$@
	echo 'filelimit=1' >>$@
	echo 'SHELL=$(SHELL)' >>$@

$(TESTS): %: %.o libcody.a
	$(CXX) $(LDFLAGS) $< -lcody $(LIBS) -o $@

clean::
	rm -f $(TESTS)
	rm -f $(TESTS:=.o) $(TESTS:=.d)

ifeq ($(filter clean%,$(MAKECMDGOALS)),)
-include $(TESTS:=.d)
endif
